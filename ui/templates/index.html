<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UNGA Research Tool</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>

    <div class="container">
        <header>
            <h1>UNGA Research Tool</h1>
            <div class="mode-switcher">
                {% if demo_mode %}
                <span class="current-mode">Standard Mode</span>
                <span class="separator">|</span>
                <a href="/?demo=false">Switch to Expert SQL Mode</a>
                {% else %}
                <a href="/?demo=true">Switch to Standard Mode</a>
                <span class="separator">|</span>
                <span class="current-mode">Expert SQL Mode</span>
                {% endif %}
                <span class="separator">|</span>
                <button type="button" id="new-chat-btn" class="btn btn-secondary btn-sm" style="display: none;">+ New Chat</button>
            </div>
        </header>

        <!-- Chat Layout Container -->
        <div class="chat-layout">
            <!-- Chat Messages Container - grows to fill space -->
            <div id="chat-messages" class="chat-messages">
                <!-- Welcome message when empty -->
                <div id="welcome-message" class="welcome-message">
                    <h2>Ask a question about UN resolutions</h2>
                    <p class="helper-text">Quick Answer: Direct SQL result. Think More: AI agent iterates on your query for deeper insights.</p>
                    {% if demo_mode and demo_questions %}
                    <div class="chips-row">
                        <p>Example questions:</p>
                        {% for question in demo_questions %}
                        <button type="button" class="chip demo-question-chip" data-question="{{ question | e }}">
                            {{ question }}
                        </button>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Input at bottom -->
            <div class="chat-input-wrapper card">
                {% if error %}
                <div class="summary-box" style="background: var(--error-bg); border-color: var(--error-border); color: var(--error-text); margin-bottom: var(--space-sm);">
                    <strong>Error:</strong> {{ error }}
                </div>
                {% endif %}

                <form method="post" action="/text-to-sql?demo={{ 'true' if demo_mode else 'false' }}" data-loading="Analyzing query..." id="search-form">
                    <input type="hidden" name="execute" value="true">
                    <input type="hidden" name="conversation_id" id="conversation-id-input" value="">
                    <div class="search-input-group">
                        <input type="text" name="natural_language_query"
                               placeholder="Ask about UN resolutions..."
                               value="{{ natural_language_query or '' }}" autocomplete="off">

                        <button type="submit" class="btn btn-primary">
                            Send
                        </button>
                    </div>

                    <!-- RAG Mode Selector -->
                    <div class="research-mode-selector">
                        <span class="mode-label">Mode:</span>
                        <label title="Direct answer using a single generated SQL query">
                            <input type="radio" name="mode" value="fast" checked>
                            <span class="mode-name">‚ö° Quick</span>
                        </label>
                        <label title="Agentic reasoning that can explore multiple sources and self-correct">
                            <input type="radio" name="mode" value="deep">
                            <span class="mode-name">üß† Think More</span>
                        </label>
                    </div>
                </form>
            </div>
        </div>

        {% if rag_answer %}
        <div class="answer-card">
            <h2>Answer</h2>
            <div class="answer-content">
                {{ rag_answer.answer }}
            </div>

            {% if rag_answer.steps %}
            <details>
                <summary>üî¨ Research Steps ({{ rag_answer.steps|length }})</summary>
                <div>
                    {% for step in rag_answer.steps %}
                    <div class="research-step">
                        <div class="research-step-header">
                            <strong>{{ loop.index }}. {{ step.tool }}</strong>
                            <span class="research-step-time">{{ "%.2f"|format(step.execution_time) }}s</span>
                        </div>
                        <div class="research-step-detail">
                            <strong>Arguments:</strong> {{ step.arguments | tojson }}
                        </div>
                        {% if step.result and not step.result.error %}
                        <div class="research-step-detail">
                            <strong>Result:</strong>
                            {% if step.tool == 'get_votes' %}
                                {{ step.result.total_countries }} countries voted
                            {% elif step.tool == 'get_utterances' %}
                                {{ step.result.count }} statements found
                            {% elif step.tool == 'get_related_documents' %}
                                {{ (step.result.meetings|length) + (step.result.drafts|length) + (step.result.committee_reports|length) }} related documents
                            {% else %}
                                {{ step.result | tojson }}
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            {% if rag_answer.sources %}
            <details>
                <summary>Sources ({{ rag_answer.sources|length }})</summary>
                <div>
                    {% for source in rag_answer.sources %}
                    <span class="badge badge-pdf" style="margin-right: var(--space-xs); margin-bottom: var(--space-xs); display: inline-block; cursor: pointer;"
                          onclick="window.open('https://digitallibrary.un.org/search?ln=en&cc=Voting+Data&p=' + encodeURIComponent('{{ source }}'), '_blank')">
                        {{ source }}
                    </span>
                    {% endfor %}
                </div>
            </details>
            {% endif %}

            {% if rag_answer.evidence %}
            <details>
                <summary>Evidence Details</summary>
                <div>
                    {% for ev in rag_answer.evidence %}
                    <div class="evidence-item">
                        <strong>{{ ev.type|title }}:</strong>
                        {% if ev.symbol %}<code>{{ ev.symbol }}</code>{% endif %}
                        {% if ev.data %}
                        <div class="research-step-detail">
                            {% for key, value in ev.data.items() %}
                            <span>{{ key }}: {{ value }}</span>{% if not loop.last %} | {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if ev.text_excerpt %}
                        <div class="evidence-excerpt">
                            "{{ ev.text_excerpt[:200] }}{% if ev.text_excerpt|length > 200 %}...{% endif %}"
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endif %}
        </div>
        {% endif %}

        {% if result %}
        <div class="card">
            <div class="results-header">
                <div>
                    <strong>Results Found:</strong> {{ result.row_count }}
                    {% if result.truncated %} <span style="color: var(--text-secondary); font-weight: 400;">(showing first {{ result.rows|length }})</span>{% endif %}
                </div>
                <div style="display: flex; gap: var(--space-xs); flex-wrap: wrap;">
                    <button id="download-btn" class="btn btn-secondary" type="button">
                        ‚¨áÔ∏è Download CSV
                    </button>
                    {% if not demo_mode %}
                    <button id="summarize-btn" class="btn btn-accent">
                        ‚ú® Summarize
                    </button>
                    <button id="answer-btn" class="btn btn-accent">
                        üí¨ Answer Question
                    </button>
                    {% endif %}
                </div>
            </div>

            <div id="summary-container" style="display: none;"></div>
            <div id="answer-container" style="display: none;"></div>

            <div class="table-container">
                <table class="results-table">
                    <thead>
                        <tr>
                            {% for column in result.columns %}
                            <th>{{ column.replace('_', ' ') }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in result.rows %}
                        <tr>
                            {% for column in result.columns %}
                            {% set cell = row[column] %}
                            <td>
                                <div class="cell-value">
                                    {% if cell.truncated %}
                                    <details>
                                        <summary>{{ cell.display }}</summary>
                                        <pre>{{ cell.full }}</pre>
                                    </details>
                                    {% else %}
                                    {{ cell.display }}
                                    {% endif %}
                                </div>

                                {% if cell.long_text or cell.link %}
                                <div class="actions">
                                    {% if cell.long_text %}
                                    <button type="button" class="badge badge-text text-expand-btn" 
                                            data-full-text="{{ cell.long_text | e }}" 
                                            data-column-name="{{ column }}">
                                        Read Text
                                    </button>
                                    {% endif %}
                                    {% if cell.link %}
                                    <a href="{{ cell.link }}" target="_blank" class="badge badge-pdf">
                                        PDF ‚Üó
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        {% if not demo_mode %}
        <details class="advanced-section">
            <summary>Advanced: Edit SQL</summary>
            <div class="card">
                <form method="post" action="/" data-loading="Running SQL...">
                    <textarea name="sql_query" style="width: 100%; min-height: 100px;">{{ sql_query }}</textarea>
                    <div style="text-align: right; margin-top: var(--space-md);">
                        <button type="submit" class="btn btn-secondary" style="height: 40px;">Run SQL</button>
                    </div>
                </form>
            </div>
        </details>
        {% endif %}

        {% if demo_mode and sql_query %}
        <div class="card sql-demo-view">
            <details>
                <summary>View Generated SQL (Demo)</summary>
                <pre>{{ sql_query }}</pre>
            </details>
        </div>
        {% endif %}

    </div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p>Processing...</p>
    </div>

    <div id="text-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Full Text</h3>
                <button type="button" class="close-modal" onclick="document.getElementById('text-modal').classList.remove('active')">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="modal-body-content" style="white-space: pre-wrap;"></pre>
            </div>
        </div>
    </div>

    {% if result %}
    <script>
        window.RESULT_DATA = {{ result | tojson | safe }};
        window.SQL_QUERY = {{ sql_query | tojson | safe }};
        window.NL_QUERY = {{ natural_language_query | tojson | safe }};
    </script>
    {% endif %}

    <script>
        // Conversation State Management
        const ConversationManager = {
            STORAGE_KEY: 'rag_conversation_id',

            get() {
                return sessionStorage.getItem(this.STORAGE_KEY);
            },

            set(conversationId) {
                sessionStorage.setItem(this.STORAGE_KEY, conversationId);
                document.getElementById('conversation-id-input').value = conversationId;
                document.getElementById('new-chat-btn').style.display = 'inline-block';
            },

            clear() {
                sessionStorage.removeItem(this.STORAGE_KEY);
                document.getElementById('conversation-id-input').value = '';
                document.getElementById('new-chat-btn').style.display = 'none';
                // Clear chat messages but keep welcome message
                const chatMessages = document.getElementById('chat-messages');
                const welcomeMsg = document.getElementById('welcome-message');
                // Remove all chat messages (but not welcome)
                chatMessages.querySelectorAll('.chat-message').forEach(msg => msg.remove());
                // Show welcome message again
                if (welcomeMsg) {
                    welcomeMsg.style.display = 'block';
                }
            },

            init() {
                const existingId = this.get();
                if (existingId) {
                    document.getElementById('conversation-id-input').value = existingId;
                    document.getElementById('new-chat-btn').style.display = 'inline-block';
                }
            }
        };

        // Initialize conversation state on page load
        document.addEventListener('DOMContentLoaded', () => {
            ConversationManager.init();
        });

        // New Chat button handler
        document.getElementById('new-chat-btn')?.addEventListener('click', () => {
            ConversationManager.clear();
            // Also clear any existing answer card from server-rendered content
            const existingAnswer = document.querySelector('.answer-card');
            if (existingAnswer) {
                existingAnswer.remove();
            }
        });

        // Helper function to append a message to chat
        function appendMessage(role, content, isLoading = false) {
            const messagesContainer = document.getElementById('chat-messages');

            // Hide welcome message when first message is sent
            const welcomeMsg = document.getElementById('welcome-message');
            if (welcomeMsg) {
                welcomeMsg.style.display = 'none';
            }

            const msgId = 'msg-' + Date.now();
            const div = document.createElement('div');
            div.id = msgId;
            div.className = `chat-message ${role}-message`;
            if (isLoading) {
                div.innerHTML = `<div class="message-content"><span class="loading-spinner"></span> ${content}</div>`;
            } else {
                div.innerHTML = `<div class="message-content">${content}</div>`;
            }
            messagesContainer.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
            return msgId;
        }

        // Helper function to update a message
        function updateMessage(msgId, content) {
            const div = document.getElementById(msgId);
            if (div) {
                const messageContent = div.querySelector('.message-content');
                if (messageContent) {
                    messageContent.innerHTML = content;
                }
            }
        }

        // Store SQL results for download
        let lastQueryResults = null;

        // Format answer HTML from API response
        function formatAnswerHTML(data) {
            if (!data) {
                return '<div class="error-message">No response received</div>';
            }

            const answer = data.answer || 'No answer provided';
            let html = `<div class="answer-content">${answer.replace(/\n/g, '<br>')}</div>`;

            // Extract SQL query and results from steps
            let sqlQuery = data.sql || null;
            let sqlResult = null;

            if (data.steps && data.steps.length > 0) {
                const sqlStep = data.steps.find(s => s.tool === 'execute_sql_query');
                if (sqlStep && sqlStep.result) {
                    sqlResult = sqlStep.result;
                    sqlQuery = sqlQuery || sqlResult.sql_query;
                    // Store for download
                    lastQueryResults = sqlResult;
                }
            }

            // SQL Query section
            if (sqlQuery) {
                html += `<details><summary>SQL Query</summary>
                    <pre style="background: var(--bg-tertiary); padding: var(--space-sm); border-radius: var(--radius-sm); overflow-x: auto; margin-top: var(--space-sm); font-size: var(--font-size-sm);">${escapeHtml(sqlQuery)}</pre>
                </details>`;
            }

            // Data Results section
            if (sqlResult && sqlResult.rows && sqlResult.rows.length > 0) {
                const columns = sqlResult.columns || Object.keys(sqlResult.rows[0]);
                const rows = sqlResult.rows;
                const rowCount = sqlResult.row_count || rows.length;
                const truncated = sqlResult.truncated || rows.length < rowCount;

                html += `<details><summary>Data Results (${rowCount} rows${truncated ? ', showing ' + rows.length : ''})</summary>
                    <div style="margin-top: var(--space-sm);">
                        <button type="button" class="btn btn-secondary btn-sm download-results-btn" style="margin-bottom: var(--space-sm);">Download CSV</button>
                        <div style="overflow-x: auto;">
                            <table class="results-table" style="font-size: var(--font-size-sm);">
                                <thead><tr>`;

                columns.forEach(col => {
                    html += `<th>${escapeHtml(col)}</th>`;
                });

                html += `</tr></thead><tbody>`;

                // Show max 10 rows in preview
                const previewRows = rows.slice(0, 10);
                previewRows.forEach(row => {
                    html += '<tr>';
                    columns.forEach(col => {
                        const val = row[col];
                        const displayVal = val !== null && val !== undefined ? String(val) : '';
                        const truncatedVal = displayVal.length > 100 ? displayVal.substring(0, 100) + '...' : displayVal;
                        html += `<td>${escapeHtml(truncatedVal)}</td>`;
                    });
                    html += '</tr>';
                });

                if (rows.length > 10) {
                    html += `<tr><td colspan="${columns.length}" style="text-align: center; font-style: italic;">... and ${rows.length - 10} more rows</td></tr>`;
                }

                html += `</tbody></table></div></div></details>`;
            }

            // Sources section
            if (data.sources && data.sources.length > 0) {
                html += `<details><summary>Sources (${data.sources.length})</summary><div style="margin-top: var(--space-sm);">`;
                data.sources.forEach(source => {
                    html += `<span class="badge badge-pdf" style="margin-right: var(--space-xs); margin-bottom: var(--space-xs); display: inline-block;">${source}</span>`;
                });
                html += '</div></details>';
            }

            // Research Steps section
            if (data.steps && data.steps.length > 0) {
                html += `<details><summary>Research Steps (${data.steps.length})</summary><div style="margin-top: var(--space-sm);">`;
                data.steps.forEach((step, i) => {
                    html += `<div class="research-step" style="margin-bottom: var(--space-xs);">${i+1}. ${step.tool || 'unknown'}`;
                    if (step.execution_time) {
                        html += ` <span style="color: var(--text-secondary);">(${step.execution_time.toFixed(2)}s)</span>`;
                    }
                    html += '</div>';
                });
                html += '</div></details>';
            }

            return html;
        }

        // Helper to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Handle download button clicks (delegated)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('download-results-btn')) {
                if (!lastQueryResults || !lastQueryResults.rows) {
                    alert('No data available to download');
                    return;
                }
                downloadCSV(lastQueryResults);
            }
        });

        // Download results as CSV
        function downloadCSV(result) {
            const columns = result.columns || Object.keys(result.rows[0]);
            const rows = result.rows;

            let csv = columns.map(c => `"${c.replace(/"/g, '""')}"`).join(',') + '\n';
            rows.forEach(row => {
                csv += columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'query-results.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // 0. Route form based on mode - now uses AJAX
        const searchForm = document.getElementById('search-form');
        if (searchForm) {
            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                e.stopImmediatePropagation(); // Prevent generic loading handler from running

                const formData = new FormData(searchForm);
                const query = formData.get('natural_language_query');

                if (!query || !query.trim()) {
                    return;
                }

                // Show user message immediately
                appendMessage('user', query);

                // Clear input
                const queryInput = searchForm.querySelector('input[name="natural_language_query"]');
                queryInput.value = '';

                // Show loading state in chat
                const loadingId = appendMessage('assistant', 'Thinking...', true);

                // Ensure loading overlay is hidden
                document.getElementById('loading-overlay').classList.remove('active');

                try {
                    console.log('Sending request to /api/multistep-answer');
                    const response = await fetch('/api/multistep-answer', {
                        method: 'POST',
                        body: formData
                    });
                    console.log('Response received:', response.status);

                    let data;
                    try {
                        data = await response.json();
                        console.log('Parsed response:', data);
                    } catch (parseError) {
                        console.error('Parse error:', parseError);
                        throw new Error('Failed to parse response');
                    }

                    if (!response.ok) {
                        throw new Error(data.error || 'Request failed');
                    }

                    // Update conversation ID for future requests
                    if (data.conversation_id) {
                        ConversationManager.set(data.conversation_id);
                    }

                    // Replace loading with actual response
                    console.log('Updating message:', loadingId);
                    const answerHtml = formatAnswerHTML(data);
                    console.log('Answer HTML length:', answerHtml.length);
                    updateMessage(loadingId, answerHtml);
                    console.log('Message updated');

                } catch (error) {
                    console.error('Chat error:', error);
                    updateMessage(loadingId, `<div class="error-message" style="color: var(--error-text);">Error: ${error.message}</div>`);
                } finally {
                    // Always ensure loading overlay is hidden
                    document.getElementById('loading-overlay').classList.remove('active');
                }
            });
        }

        // 1. Handling Demo Question Chips - now use AJAX too
        document.querySelectorAll('.demo-question-chip').forEach(btn => {
            btn.addEventListener('click', () => {
                const question = btn.dataset.question;
                const input = document.querySelector('input[name="natural_language_query"]');
                if (input) {
                    input.value = question;
                    // Trigger form submit which now uses AJAX
                    input.closest('form').dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                }
            });
        });

        // 2. Handling SQL Chips (non-demo)
        document.querySelectorAll('.chip:not(.demo-question-chip)').forEach(btn => {
            btn.addEventListener('click', () => {
                const sql = btn.dataset.sql;
                const textarea = document.querySelector('textarea[name="sql_query"]');
                const input = document.querySelector('input[name="natural_language_query"]');
                
                if (textarea && sql && sql.toUpperCase().includes('SELECT')) {
                    textarea.value = sql;
                    textarea.closest('details').open = true;
                } else if (input) {
                    input.value = btn.innerText;
                }
            });
        });

        // 2. Loading State
        document.querySelectorAll('form').forEach(f => {
            f.addEventListener('submit', () => document.getElementById('loading-overlay').classList.add('active'));
        });

        // 3. Modal Logic
        document.querySelectorAll('.text-expand-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.getElementById('modal-body-content').innerText = btn.dataset.fullText;
                document.getElementById('text-modal').classList.add('active');
            });
        });

        // 4. Summarization Logic
        const sumBtn = document.getElementById('summarize-btn');
        if(sumBtn) {
            sumBtn.addEventListener('click', async () => {
                const container = document.getElementById('summary-container');
                container.style.display = 'block';
                container.innerHTML = '<div class="summary-box">Generating summary...</div>';
                sumBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('sql_query', window.SQL_QUERY || "");
                    formData.append('natural_language_query', window.NL_QUERY || "");
                    formData.append('result_json', JSON.stringify(window.RESULT_DATA));

                    const res = await fetch('/api/summarize', { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    if(!res.ok) throw new Error(data.error || 'Error');
                    
                    container.innerHTML = `<div class="summary-box"><h3>Summary</h3>${data.summary.replace(/\n/g, '<br>')}</div>`;
                    sumBtn.innerText = 'Summarized';
                } catch(e) {
                    container.innerHTML = `<div class="summary-box" style="background:var(--error-bg); color:var(--error-text)">${e.message}</div>`;
                    sumBtn.disabled = false;
                }
            });
        }

        // 5. Answer Question Logic
        const answerBtn = document.getElementById('answer-btn');
        if(answerBtn) {
            answerBtn.addEventListener('click', async () => {
                const container = document.getElementById('answer-container');
                container.style.display = 'block';
                container.innerHTML = '<div class="summary-box">Generating answer...</div>';
                answerBtn.disabled = true;

                try {
                    const formData = new FormData();
                    formData.append('sql_query', window.SQL_QUERY || "");
                    formData.append('natural_language_query', window.NL_QUERY || "");
                    formData.append('result_json', JSON.stringify(window.RESULT_DATA));

                    const res = await fetch('/api/rag-answer', { method: 'POST', body: formData });
                    const data = await res.json();
                    
                    if(!res.ok) throw new Error(data.error || 'Error');

                    let sourcesHtml = '';
                    if(data.sources && data.sources.length > 0) {
                        sourcesHtml = `<details><summary>Sources (${data.sources.length})</summary><div>`;
                        data.sources.forEach(source => {
                            sourcesHtml += `<span class="badge badge-pdf" style="margin-right: var(--space-xs); margin-bottom: var(--space-xs); display: inline-block;">${source}</span>`;
                        });
                        sourcesHtml += '</div></details>';
                    }

                    container.innerHTML = `<div class="answer-card"><h3>Answer</h3><div class="answer-content">${data.answer.replace(/\n/g, '<br>')}</div>${sourcesHtml}</div>`;
                    answerBtn.innerText = 'Answered';
                } catch(e) {
                    container.innerHTML = `<div class="summary-box" style="background:var(--error-bg); color:var(--error-text)">${e.message}</div>`;
                    answerBtn.disabled = false;
                }
            });
        }

        // 6. Download CSV Logic
        const downloadBtn = document.getElementById('download-btn');
        if(downloadBtn) {
            const defaultText = downloadBtn.innerText;
            downloadBtn.addEventListener('click', async () => {
                if(!window.SQL_QUERY) {
                    alert('No SQL query available to download.');
                    return;
                }

                downloadBtn.disabled = true;
                downloadBtn.innerText = 'Preparing...';

                try {
                    const formData = new FormData();
                    formData.append('sql_query', window.SQL_QUERY);

                    const res = await fetch('/download-results', { method: 'POST', body: formData });
                    if(!res.ok) {
                        let errorMessage = 'Failed to download results';
                        try {
                            const data = await res.json();
                            errorMessage = data.detail || data.error || errorMessage;
                        } catch (parseErr) {
                            const text = await res.text();
                            if(text) {
                                errorMessage = text;
                            }
                        }
                        throw new Error(errorMessage);
                    }

                    const blob = await res.blob();
                    const disposition = res.headers.get('content-disposition') || '';
                    const match = disposition.match(/filename="?([^";]+)"?/i);
                    const filename = match ? match[1] : 'query-results.csv';
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                    downloadBtn.innerText = 'Downloaded';
                } catch (error) {
                    alert(error.message || 'Failed to download results');
                    downloadBtn.innerText = defaultText;
                } finally {
                    setTimeout(() => {
                        downloadBtn.disabled = false;
                        downloadBtn.innerText = defaultText;
                    }, 1200);
                }
            });
        }
    </script>
</body>
</html>
